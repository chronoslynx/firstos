image: nixos/unstable
secrets:
  - 48978e77-a93a-4dcf-97b8-3cced6509601
repositories:
  nixpkgs: https://nixos.org/channels/nixpkgs-unstable
packages:
  - nixpkgs.niv
  - nixpkgs.qemu.out
  - nixpkgs.cachix
sources:
  - https://git.sr.ht/~timods/firstos
tasks:
  - setup: |
      cd firstos
      cachix use timods-ci
      cachix authtoken "$(cat ~/.cachix-key)"
      nix-shell --run "echo OK"
      nix-store --query --references $(nix-instantiate shell.nix) \
          | xargs nix-store --realise \
          | xargs nix-store --query --requisites \
          | cachix push timods-ci
  - test: |
      cd firstos
      nix-shell --run "cargo test" shell.nix
