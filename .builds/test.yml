image: nixos/unstable
secrets:
  - 48978e77-a93a-4dcf-97b8-3cced6509601
repositories:
  nixpkgs: https://nixos.org/channels/nixpkgs-unstable
packages:
  - nixpkgs.qemu.out
  - nixpkgs.cachix
sources:
  - https://git.sr.ht/~timods/firstos
tasks:
  - setup: |
      cd firstos
      mkdir -p ~/.config/nix/
      sudo cat <<EOF > /etc/nixos/configuration.nix
        { pkgs, ... }: {
          nix = {
            package = pkgs.nixFlakes;
            extraOptions = ''
              experimental-features = nix-command flakes
            '';
            };
        }
      EOF
      nixos-rebuild test
      cachix use timods-ci
      cachix authtoken "$(cat ~/.cachix-key)"
      nix develop --command "echo OK"
      nix flake archive --json \
      | jq -r '.path,(.inputs|to_entries[].value.path)' \
      | cachix push timods-ci
  - test: |
      cd firstos
      nix develop --command "cargo test"
